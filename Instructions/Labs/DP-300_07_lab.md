---
lab:
  title: 实验室 7 – 规划和实现高可用性和灾难恢复环境
  module: Planning and Implementing a High Availability and Disaster Recovery Environment
---

# <a name="lab-7--planning-and-implementing-a-high-availability-and-disaster-recovery-environment"></a>实验室 7 – 规划和实现高可用性和灾难恢复环境

预计用时：90 分钟

先决条件：练习 1 使用的 Azure SQL 数据库是在实验室中为模块 3 创建的。 

实验室文件：本实验室的文件位于“D:\Labfiles\High Availability”文件夹中。

# <a name="lab-overview"></a>实验室概述

学生将执行两个主要任务：使 Azure SQL 数据库异地冗余，并备份到使用 Azure 的 URL 并从其中还原。 

# <a name="lab-objectives"></a>实验室目标

完成本实验室后，你将能够：

- 为 Azure SQL 数据库启用异地复写

- 使用 URL 备份和还原 SQL Server 数据库


# <a name="scenario"></a>场景

Now that you have automated day-to-day tasks in the previous lab, as the Senior Data Engineer, you are tasked with improving the availability of both IaaS and PaaS configurations for your database environment. You are tasked with the following objectives:

- 为 Azure SQL 数据库启用异地复制，以提高数据库的可用性。

- 将数据库备份到 Azure 中的 URL，并在发生人为错误后将其还原。


# <a name="exercise-1-enable-geo-replication-for-azure-sql-database"></a>练习 1：为 Azure SQL 数据库启用异地复制

预计时间：45 分钟

概述

学生们将修改在模块 3 的实验室中创建的 Azure SQL 数据库配置，以使其高度可用。

场景

作为 WideWorldImporters 中的 DBA，你需要知道如何为 Azure SQL 数据库启用异地复制，并确保其正常运行，并知道如何使用门户手动将其故障转移到另一个区域。

先决条件

- 为学生创建的 Azure 帐户 – 必须提供登录名（电子邮箱）和密码

- 预先创建的 Azure SQL Database 服务器和数据库

 

1. 如果未通过浏览器窗口登录 Azure 门户，请使用提供的 Azure 凭据进行登录。

2. 从菜单中选择 SQL 数据库，如下所示。

    ![图片 16](../images/dp-3300-module-77-lab-01.png)

3. Click on the Azure SQL Database that was created in Lab 3. An example is shown below.

    ![图片 17](../images/dp-3300-module-77-lab-02.png)

4. 在数据库的边栏选项卡中，在“数据管理”下选择“复制”。

    ![图片 18](../images/dp-3300-module-77-lab-03.png)

5. 然后单击左上角的“创建复制”按钮。

    ![图片 20](../images/dp-3300-module-77-lab-05.png)

6. Under <bpt id="p1">**</bpt>Server<ept id="p1">**</ept>, select <bpt id="p2">**</bpt>Create New<ept id="p2">**</ept>. On the new server pane, enter a unique server name, a valid admin login, and a secure password, and select the region you chose as the target region and then click <bpt id="p1">**</bpt>OK<ept id="p1">**</ept> to create the server.

7. Back in the Geo-Replica blade, click <bpt id="p1">**</bpt>Review + Create<ept id="p1">**</ept>, and then click <bpt id="p2">**</bpt>Create<ept id="p2">**</ept>. The secondary server and the database will now be created. To check the status, look under the bell icon at the top of the portal. If successful, it will progress from Deployment in progress to Deployment succeeded.

8. Now that the Azure SQL Database is configured with replicas, you will perform a failover. Select the <bpt id="p1">**</bpt>Replicas<ept id="p1">**</ept> page for the secondary server and note that the primary and secondary servers are indicated.

9. 选择辅助服务器的“...”菜单，然后单击“强制故障转移” 。

    ![图片 28](../images/dp-3300-module-77-lab-10.png)

10. 系统提示时，单击“是”****。 

    The status of the primary replica will switch to Pending and the secondary, Failover. The process will take a few minutes. When complete, the roles will switch with the secondary becoming the new primary and the old primary becoming the secondary.

# <a name="exercise-2-backup-to-url-and-restore-from-url"></a>练习 2：备份到 URL 并从网址还原

预计时间：45 分钟

本练习的任务如下所示：

- 配置备份到 URL

- 备份 WideWorldImporters

- 还原 WideWorldImporters

## <a name="task-1-configure-backup-to-url"></a>任务 1：配置“备份到 URL”

在将 SQL Server 中的数据库备份到 Azure 之前，需要执行一些配置任务。 

<bpt id="p1">**</bpt>Note:<ept id="p1">**</ept> There are several long strings, including storage account keys and shared access signatures, that are generated and then reused. You should consider opening up a Notepad file within the lab VM to use for holding these strings. 

1. 验证你的上下文是否为 LON-SQL1 虚拟机。

2. 启动 Microsoft Edge 并登录到 Azure 门户 ([https://portal.azure.com](https://portal.azure.com/))，若你已在该处则不必。

3. 选择下图右上角所示的图标，打开 Cloud Shell 提示。

    ![图 2](../images/dp-3300-module-77-lab-13.png)

4. At the bottom half of the portal, you may see a message welcoming you to Azure Cloud Shell, if you have not yet used Cloud Shell. Select Bash.

    ![图片 3](../images/dp-3300-module-77-lab-14.png)

5. If you have not previously used Cloud Shell, you must give it storage. Click Create Storage in the dialog below.

    ![图片 4](../images/dp-3300-module-77-lab-15.png)


6. If you have already used Cloud Shell, just make sure the upper left corner of the Cloud shell screen shows Bash. You can use the drop down arrow to select either PowerShell or Bash. 
 

    完成后，你将看到类似于下图的提示符。

    ![图片 5](../images/dp-3300-module-77-lab-16.png)


7. 通过将以下命令复制到 Cloud Shell 中，从 CLI 创建存储帐户。

    ```
    az storage account create -n dp300storage -g DP-300-Lab02 --kind StorageV2 -l eastus2
    ```

    Edit the command so that your storage account name is unique and all lower case with no special characters. You should change <bpt id="p1">*</bpt>dp300storage<ept id="p1">*</ept> in the above to a unique name like <bpt id="p2">*</bpt>dp300storagemsl123<ept id="p2">*</ept>. The value <bpt id="p1">*</bpt>DP-300-Lab02<ept id="p1">*</ept> is the name of an existing Resource Group. Make sure you use one that has been created in an earlier lab. Change the region if desired. Press Enter to run the command. 


    Next you will get the account keys for your account, which you will use in subsequent steps. Execute the following code in cloud shell, after editing to use the same name (after the -n) and resource group (after the -g) that you used in the previous command.

    ```
    az storage account keys list -g DP-300-Lab02 -n dp300storage
    ```

    Your account key will be in the results of the above command. Make sure you  Copy the returned value for key1 (without the double quotes) as shown here. You might save it in Notepad. 


    ![图片 2059189454](../images/dp-3300-module-77-lab-17.png)
 

8. 作为高级数据工程师，你已经在上一个实验室中完成了日常的自动化任务，现在的任务是为数据库环境提升 IaaS 和 PaaS 配置的可用性。

    ```
    az storage container create --name "backups" --account-name "dp300storage" --account-key "storage_key" --fail-on-exist
    ```
 
    输出应返回“true”。

    ![图 1](../images/dp-3300-module-77-lab-18.png)


9. 若要进一步验证是否已创建容器备份，请执行以下操作，其中 dp300storage 是你创建的存储帐户名，而 storage_key 是你在上面生成的密钥 。 

    ```
    az storage container list --account-name "dp300storage" --account-key "storage_key"
    ```

    部分输出应返回与以下类似的内容。

    ![图片 6](../images/dp-3300-module-77-lab-19.png)


10. 你的任务是实现以下目标：

    ```
    az storage container generate-sas -n "backups" --account-name "dp300storage" --account-key "storage_key" --permissions "rwdl" --expiry "date_in_the_future" -o tsv
    ```
    **注意：到期日的格式为“YYYY-MM-DD”，其中 YYYY 是四位数的年份，MM 是两位数的月份，DD 是两位数的日期。**

    The output should return something similar to the value shown below which will be used in the next Task. You can copy and save the value in Notepad along with the key you saved earlier. 

    ![图 25](../images/dp-3300-module-77-lab-20.png)


## <a name="task-2-back-up-wideworldimporters"></a>任务 2：备份 WideWorldImporters

现在功能已配置，你可以将备份文件生成为 Azure 中的 Blob。 

1. 打开 SQL Server Management Studio，并确保已连接到 LON-SQL1。

2. 单击“新建查询”。

3. Create the credential that will be used to access storage in the cloud with the following Transact-SQL. (If a credential already exists, drop it first.) Fill in the appropriate values, where <bpt id="p1">*</bpt>dp300storage<ept id="p1">*</ept> is the storage account name created in Task 1, Step 8 and <bpt id="p2">*</bpt>sas_token<ept id="p2">*</ept> is the value generated in Task 1, Step 10 (starting with <bpt id="p3">*</bpt>se=...<ept id="p3">*</ept>). 

    ```sql
    IF EXISTS 

    (SELECT * FROM sys.credentials 

    WHERE name = 'https://dp300storage.blob.core.windows.net/backups') 

    BEGIN
    
        DROP CREDENTIAL [https://dp300storage.blob.core.windows.net/backups]
        
    END
    
    GO


    CREATE CREDENTIAL [https://dp300storage.blob.core.windows.net/backups]

    WITH IDENTITY = 'SHARED ACCESS SIGNATURE',

    SECRET = 'sas_token'

    GO 
    ```
    

4. Click <bpt id="p1">**</bpt>Execute<ept id="p1">**</ept>. This should be successful.

5. 在 Transact-SQL 中使用以下命令将数据库 WideWorldImporters 备份到 Azure，其中 dp300storage 是任务 1 中使用的存储帐户名称：

    ```sql
    BACKUP DATABASE WideWorldImporters 

    TO URL = 'https://dp300storage.blob.core.windows.net/backups/WideWorldImporters.bak';

    GO 
    ```

    This may take some time. If successful, you should see output similar to this:

    已处理 1240 页的数据库“WideWorldImporters”，文件 1 上的文件“WWI_Primary”。

    已处理 53104 页数据库“WideWorldImporters”，文件 1 上的文件“WWI_UserData”。

    已处理 3865 页的数据库“WideWorldImporters”，文件 1 上的文件“WWI_InMemory_Data_1”。

    已处理 1468页的数据库“WideWorldImporters”，文件 1 上的文件“WWI_Log”。

    BACKUP DATABASE 在 14.839 秒内成功处理了 59677 页（31.419 MB/秒）。

    完成时间：2020-05-18T08:01:41.6935863+00:00

    

    如果一些配置错误，你将看到类似以下内容的错误消息：

    消息 3201，级别 16，状态 1，第 33 行  
    ‎Cannot open backup device '<ph id="ph1">https://dp300storage.blob.core.windows.net/container_name/WideWorldImporters.bak</ph>'. Operating system error 50(The request is not supported.).  
    消息 3013，级别 16，状态 1，第 33 行  
    BACKUP DATABASE 异常终止。


    检查确认没有输错任何内容并成功创建所有内容。

6. To see that the file is actually in Azure, you can use Storage Explorer or Azure Cloud Shell. The syntax in Bash is as follows, where <bpt id="p1">*</bpt>dp300storage<ept id="p1">*</ept> is the storage account name used in Task 1, and <bpt id="p2">*</bpt>account_key<ept id="p2">*</ept> is the key used there as well. 
    ```
    az storage blob list -c "backups" --account-name "dp300storage" --account-key "storage_key"
    ```
    
    示例输出如下所示。

    ![图片 37](../images/dp-3300-module-77-lab-21.png)

 
## <a name="task-3-restore-wideworldimporters"></a>任务 3：还原 WideWorldImporters

此任务展示如何还原数据库。


1. 在 SQL Server Management Studio 的“新建查询”窗口中，执行 
    ```sql
    USE WideWorldImporters;
    GO
    
    ```

2. Now execute the statement below to return the very first row of the Customers table which has a CustomerID of 1. Note the name of the customer.
    ```sql
    SELECT TOP 1 * FROM Sales.Customers;
    GO
    
    ```
    
3. 运行此命令更改该客户的名字。
    ```sql
    UPDATE Sales.Customers
    SET CustomerName = 'This is a human error'
    WHERE CustomerID = 1;
    GO
    
    ```

4. Re-run Step 2 to verify that the name has been changed. Now imagine if someone had changed thousands or millions of rows without a WHERE clause – or the wrong WHERE clause.

5. 要还原数据库以使其恢复到在步骤 3 中进行更改之前的状态，请关闭当前连接到 WideWorldImporters 数据库的所有查询，然后执行以下命令，其中 dp300storage 是任务 1 中使用的存储帐户名称。

    ```sql
    USE master;
    GO

    RESTORE DATABASE WideWorldImporters 
    FROM URL = 'https://dp300storage.blob.core.windows.net/backups/WideWorldImporters.bak';
    GO
    ```

    This may take some time. The output should be similar to this:

    已处理 1240 页的数据库“WideWorldImporters”，文件 1 上的文件“WWI_Primary”。

    已处理 53104 页数据库“WideWorldImporters”，文件 1 上的文件“WWI_UserData”。

    已处理 1468页的数据库“WideWorldImporters”，文件 1 上的文件“WWI_Log”。

    已处理 3865 页的数据库“WideWorldImporters”，文件 1 上的文件“WWI_InMemory_Data_1”。

    RESTORE DATABASE successfully processed 59677 pages in 16.167 seconds (28.838 MB/sec).

    完成时间：5/18/2020 8:35:06 AM

6. When the restore of WideWorldImporters is finished, re-run Steps 1 and 2. The data will be back to what it was.
